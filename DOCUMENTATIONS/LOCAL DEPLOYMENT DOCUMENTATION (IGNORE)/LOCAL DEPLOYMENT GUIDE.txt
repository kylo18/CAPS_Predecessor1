LOCAL DEPLOMENT GUIDE

1. Open command prompt in administration mode

2. Make sure you have wsl in your desktop 
    - If you're not sure you have wsl in desktop
    - Type: wsl -v
    - It should should show something like this 
    
    WSL version: 2.4.13.0
    Kernel version: 5.15.167.4-1
    WSLg version: 1.0.65
    MSRDC version: 1.2.5716
    Direct3D version: 1.611.1-81528511
    DXCore version: 10.0.26100.1-240331-1435.ge-release
    Windows version: 10.0.26200.7840

    - If you dont have wsl Type: wsl --install
    - Type: "wsl -v" to confirm if it's installed successfully
 3. Install Docker desktop

 4. Go to the Frontend - Deployment Folder
    - Go inside Dockerfile and paste this value
    
    FROM node:20-bullseye as builder
    WORKDIR /app

    # Copy only package files first for caching
    COPY package*.json ./

    # Install dependencies
    RUN npm install --legacy-peer-deps

    # Copy the rest of the application code
    COPY . .

    # Fix heap out-of-memory issue by increasing memory limit for Node.js
    RUN NODE_OPTIONS="--max-old-space-size=2048" npm run build

    # Serve the built files with nginx
    FROM nginx:alpine
    COPY --from=builder /app/dist /usr/share/nginx/html
    COPY nginx.conf /etc/nginx/conf.d/default.conf

    # Clean up default nginx 50x error page (optional)
    RUN rm -rf /usr/share/nginx/html/50x.html

    EXPOSE 80

    - Save it then close the file

5. Create an file named ".env"
    -paste this value
        
    # Frontend base config
    VITE_API_BASE_URL=http://localhost:8000/api

    -Save it and close 



6. Go to Backend - Deployment Folder
    - Go inside its Dockerfile and paste this value

    # Use an official PHP image with Apache (Debian-based OS)
    FROM php:8.2-apache

    # Install required PHP extensions and dependencies
    RUN apt-get update && apt-get install -y \
        unzip \
        curl \
        libpng-dev \
        libjpeg62-turbo-dev \
        libfreetype6-dev \
        && docker-php-ext-install pdo pdo_mysql gd

    # Enable Apache rewrite module (Laravel requires this)
    RUN a2enmod rewrite

    # Set Apache's DocumentRoot to Laravel's "public" directory
    ENV APACHE_DOCUMENT_ROOT=/var/www/html/public

    # Update Apache config to point to the new DocumentRoot
    RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/000-default.conf

    # Set working directory
    WORKDIR /var/www/html

    # Copy Laravel project files into the container
    COPY . .

    # Install Composer
    RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    # Install Laravel PHP dependencies
    RUN composer install --no-dev --optimize-autoloader

    # Set correct permissions for storage and cache
    RUN chown -R www-data:www-data /var/www/html \
        && chmod -R 775 /var/www/html/storage \
        && chmod -R 775 /var/www/html/bootstrap/cache

    # Copy custom entrypoint script
    COPY docker-entrypoint.sh /entrypoint.sh
    RUN chmod +x /entrypoint.sh

    # Set entrypoint
    ENTRYPOINT ["/entrypoint.sh"]

    # Expose port 80
    EXPOSE 80

7. Create a file named ".env"
    -paste this value

    APP_NAME=CAPS 
    APP_ENV=local
    APP_FORCE_HTTPS=true # Force app to be served in https
    APP_KEY=
    APP_DEBUG=true
    APP_URL=http://localhost:8000/api
    FRONTEND_URL= # added this line to make reset password through email work. Change this with the actual production url
    APP_VERSION=1.1.0

    LOG_CHANNEL=stack
    LOG_DEPRECATIONS_CHANNEL=null
    LOG_LEVEL=debug

    DB_CONNECTION=mysql
    DB_HOST=mysql
    DB_PORT=3306
    DB_DATABASE=laravel
    DB_USERNAME=caps_user
    DB_PASSWORD=password

    BROADCAST_DRIVER=log
    CACHE_DRIVER=file
    QUEUE_CONNECTION=sync
    SESSION_DRIVER=database 
    SESSION_LIFETIME=120

    FILESYSTEM_DISK=local

    # If you're using Laravel Sanctum, set this for CORS
    SANCTUM_STATEFUL_DOMAINS=caps-test2.coeofjrmsu.com

    # Optional: If sending emails
    MAIL_MAILER=smtp
    MAIL_HOST=smtp.gmail.com # modified this line to make reset password through email work
    MAIL_PORT=587 # modified this line to make reset password through email work
    MAIL_USERNAME= # modified this line to make reset password through email work. 
    MAIL_PASSWORD=miafcfzompsbabam # modified this line to make reset password through email work
    MAIL_ENCRYPTION=tls
    MAIL_FROM_ADDRESS= # modified this line to make reset password through email work.
    MAIL_FROM_NAME="${APP_NAME}"

    - Save it and close it

8. Create a file named "docker-compose.yml"

    - Paste this value 

    version: '3.8'

    networks:
    caps_network:
        driver: bridge

    services:
    backend:
        build:
        context: "./Backend - Deployment" 
        dockerfile: Dockerfile
        command: php artisan serve --host=0.0.0.0 --port=8000
        container_name: backend
        networks:
        - caps_network
        ports:
        - "8000:8000"
        volumes:
        # - ./caps-backend:/var/www/html   # <-- still commented
        - ./docker-data/backend_pictures:/var/www/html/storage/app/public
        depends_on:
        - mysql
        environment:
        DB_CONNECTION: mysql
        DB_HOST: mysql
        DB_PORT: 3306
        DB_DATABASE: laravel
        DB_USERNAME: caps_user
        DB_PASSWORD: password 

    frontend:
        build:
        context: "./Frontend - Deployment"
        dockerfile: Dockerfile
        container_name: frontend
        networks:
        - caps_network
        ports:
        - "80:80"
        environment:
        #this should be the same as the backend's .env file
        - VITE_API_BASE_URL=http://localhost:8000/api
        depends_on:
        - backend

    mysql:
        image: mysql:8
        container_name: mysql
        restart: always
        networks:
        - caps_network
        ports:
        - "4406:3306"
        environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: laravel
        MYSQL_USER: caps_user
        MYSQL_PASSWORD: password 
        volumes:
        - ./docker-data/mysql_data:/var/lib/mysql


    phpmyadmin:
        image: phpmyadmin/phpmyadmin
        container_name: phpmyadmin
        restart: always
        environment:
        PMA_HOST: mysql
        PMA_USER: root
        PMA_PASSWORD: root 
        ports:
        - "8080:80"
        depends_on:
        - mysql
        networks:
        - caps_network

    #volumes:
    # ./docker-data/mysql_data:/var/lib/mysql:

 9. Go to the Frontend - Deployment Folder
    -make sure the folder named "package-lock.json" is deleted

10. Open Docker desktop

11. Open Command prompt as administration
    - Navigate to where your folder using this command:

            cd "Directory of your Project"

12. Build the containers and type:

        - docker compose up -d --build
        - When it is sucessful it should show this:

        ✔ backend                                 Built                                                                   0.0s
        ✔ frontend                                Built                                                                   0.0s
        ✔ Network caps_predecessor1_caps_network  Created                                                                 0.1s
        ✔ Container mysql                         Started                                                                 0.6s
        ✔ Container phpmyadmin                    Started                                                                 0.9s
        ✔ Container backend                       Started                                                                 0.8s
        ✔ Container frontend                      Started                                                                 0.9s

13. To make sure the containers are running smoothly
        -Type: docker ps
        - It should show this 

        CONTAINER ID   IMAGE                        COMMAND                  CREATED         STATUS         PORTS                               NAMES
        76fa73d15be2   caps_predecessor1-frontend   "/docker-entrypoint.…"   6 seconds ago   Up 5 seconds   0.0.0.0:80->80/tcp                  frontend
        51810795319c   caps_predecessor1-backend    "/entrypoint.sh php …"   6 seconds ago   Up 5 seconds   80/tcp, 0.0.0.0:8000->8000/tcp      backend
        42c746a391ea   phpmyadmin/phpmyadmin        "/docker-entrypoint.…"   6 seconds ago   Up 5 seconds   0.0.0.0:8080->80/tcp                phpmyadmin
        adddb95a3ebe   mysql:8                      "docker-entrypoint.s…"   6 seconds ago   Up 5 seconds   33060/tcp, 0.0.0.0:4406->3306/tcp   mysql

14. Go to the backend container 
    - Type: docker exec -it backend bash
    - Type: php artisan key:generate
    - It should show that the key is successfully generated
    - Type: exit 
    - Copy this coommand:
    
            docker exec -it backend bash
            cat .env | grep APP_KEY

    - When you see the app key of it, copy it and go to Backend - Deployment folder.
    - Go inside .env and paste the app key there and save it

15. Go back to backend container
    - Type: docker exec -it backend bash
    - Type: php artisan migrate 
    - It will show all the tables migrated. Wait for it and it should migrate smoothly.
    - Type: php artisan db:seed 
    - It will seed all the tables (NOTE: If you will see the users table error, ignore it)
    - Type: exit
    
16. To confirm the changes in the database
    - Go to your preferred browser
    - Type: localhost:8080
    - Go inside laravel database
    - Go to users table to confirm it 
    - You will see the data migrated and seeded 

17. To confirm the browser is working
    - Type in your browser: localhost:80
    - Log in in the website using these credentials

    ID: 23-A-12345
    Password: 12345678